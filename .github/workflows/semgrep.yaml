# .github/workflows/semgrep.yml
name: Semgrep CI
on:
  push:
    branches: [ "main", "master" ] # 기본 브랜치 이름에 맞게 수정하세요.
  pull_request:
  workflow_dispatch:

jobs:
  semgrep:
    # User definable name of this GitHub Actions job.
    name: Security Analysis with Semgrep
    runs-on: ubuntu-latest
    container:
      # A Docker image with Semgrep installed. Do not change this.
      image: semgrep/semgrep

    # Security 탭에 결과를 쓰기 위한 권한
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # diff 스캔 시 필요

      - name: Run Semgrep
        run: |
          semgrep ci \
            --sarif --output=semgrep.sarif \
            --config=p/java \
            --config=p/kotlin \
            --config=p/owasp-top-ten \
            --config=p/secrets \
            --config=p/security-audit \
            --config=p/docker \
            --config=p/docker-compose \
            --config=p/kubernetes \
            --config=.github/semgrep-rules.yaml


      # SARIF 결과를 GitHub Security 탭에 업로드
      - name: Upload SARIF file to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()  # Semgrep이 실패해도 결과가 있으면 업로드
        with:
          sarif_file: semgrep.sarif
          category: semgrep

# jobs:
#   semgrep:
#     name: Run Semgrep
#     runs-on: ubuntu-latest
#     container:
#       image: returntocorp/semgrep:latest   # Semgrep 공식 이미지

#     permissions:
#       security-events: write  # 보안 경고 업로드 권한
#       actions: read
#       contents: read

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0   # diff 스캔 시 필요

#       - name: Set up Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: '3.x'

#       - name: Install Semgrep
#         run: |
#           python -m pip install --upgrade pip
#           pip install semgrep

#       - name: Run Semgrep with SARIF output
#         run: semgrep scan --config .github/.semgrep.yml --sarif --output=semgrep.sarif

#       - name: Upload Semgrep SARIF results
#         uses: github/codeql-action/upload-sarif@v3
#         with:
#           sarif_file: semgrep.sarif

